rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null;
    }

    function isAdminClaim() {
      return signedIn() && request.auth.token.admin == true;
    }

    function isAdmin() {
      // Accept either custom claim (preferred) or Firestore role (bootstrap / back-compat).
      return signedIn() && (
        isAdminClaim()
        || me().role == "admin"
      );
    }

    function me() {
      return signedIn() ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data : null;
    }

    function isApproved() {
      return signedIn()
        // Back-compat: older user docs used "active" to mean approved.
        && (me().status == "approved" || me().status == "active")
        && (me().suspended != true);
    }

    function canReadPostData(postData) {
      // Per product policy: posts are publicly readable (privacy is a label + interaction gating only).
      // This avoids query failures where a single unreadable doc breaks the entire feed.
      return true;
    }

    function canReadPost(postId) {
      return canReadPostData(get(/databases/$(database)/documents/posts/$(postId)).data);
    }

    function changedKeys() {
      return request.resource.data.diff(resource.data).changedKeys();
    }

    // --- Users ---
    // NOTE: User docs contain sensitive fields (email/phone). Keep reads tight.
    match /users/{uid} {
      allow create: if signedIn()
        && request.auth.uid == uid
        && request.resource.data.role == "member"
        && request.resource.data.status == "pending";

      // IMPORTANT: avoid circular reads.
      // Never call `get(/users/{request.auth.uid})` from within `/users/*` rules.
      // Use admin custom claims for admin access to other user docs.
      allow read: if signedIn() && (request.auth.uid == uid || isAdminClaim());

      allow update: if (
          signedIn()
          && request.auth.uid != uid
          && isAdminClaim()
        )
        || (
          signedIn()
          && request.auth.uid == uid
          // Prevent privilege escalation / approval bypass.
          && request.resource.data.role == resource.data.role
          && request.resource.data.status == resource.data.status
          && request.resource.data.suspended == resource.data.suspended
        );

      allow delete: if signedIn()
        && request.auth.uid != uid
        && isAdminClaim();
    }

    // --- Partners (public showcase; admin manages) ---
    match /partners/{partnerId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // --- Carousel (public read; admin manages) ---
    match /carouselSlides/{slideId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // --- Links + Videos (public read; admin manages) ---
    match /links/{linkId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    match /videos/{videoId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // --- Events (public read; admin manages) ---
    match /events/{eventId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();

      // RSVP docs: user can manage their own RSVP; admin can read all.
      match /rsvps/{uid} {
        // Back-compat: some older RSVP docs may not use the uid as the document id.
        // Collection group queries will fail if *any* matched doc is unreadable, so allow reads
        // when the RSVP doc's stored uid matches the signed-in user.
        allow read: if isAdmin() || (signedIn() && (request.auth.uid == uid || resource.data.uid == request.auth.uid));
        allow create, update: if isApproved()
          && request.auth.uid == uid
          && request.resource.data.uid == uid;
        allow delete: if isApproved() && request.auth.uid == uid;
      }
    }

    // --- Posts (public read w/ privacy; approved write) ---
    match /posts/{postId} {
      allow read: if true;

      allow create: if (isApproved() || isAdmin())
        && request.resource.data.createdBy == request.auth.uid;

      // Owner edits (content) vs non-owner edits (comment count updates).
      allow update: if isAdmin() || (isApproved() && (
        (
          request.auth.uid == resource.data.createdBy
          && changedKeys().hasOnly([
            "title",
            "body",
            "content",
            "privacy",
            "imageUrl",
            "updatedAt",
            "commentCount"
          ])
        )
        ||
        (
          request.auth.uid != resource.data.createdBy
          && changedKeys().hasOnly(["commentCount", "updatedAt"])
        )
      ));

      allow delete: if isAdmin() || (isApproved() && request.auth.uid == resource.data.createdBy);

      // Likes (subcollection model)
      match /likes/{uid} {
        allow read: if true;
        allow create, delete: if (isApproved() || isAdmin()) && request.auth.uid == uid;
      }

      // Saves (subcollection model)
      match /saves/{uid} {
        allow read: if signedIn() && request.auth.uid == uid;
        allow create, delete: if (isApproved() || isAdmin()) && request.auth.uid == uid;
      }

      // Legacy comments subcollection (we dual-write for back-compat).
      match /comments/{commentId} {
        allow read: if true;
        allow create: if (isApproved() || isAdmin())
          && request.resource.data.createdBy == request.auth.uid;
        allow delete: if isAdmin() || (isApproved() && resource.data.createdBy == request.auth.uid);
      }
    }

    // Prompt-aligned top-level comments
    match /comments/{commentId} {
      allow read: if true;
      allow create: if (isApproved() || isAdmin())
        && request.resource.data.createdBy == request.auth.uid
        && true;
      allow delete: if isAdmin() || (isApproved() && resource.data.createdBy == request.auth.uid);
    }

    // Notifications (optional feature)
    match /notifications/{id} {
      allow read: if signedIn() && resource.data.userId == request.auth.uid;
      allow create: if isApproved();
      allow update, delete: if isAdmin();
    }

    // Issue reports (user-friendly error reporting)
    // - Signed-in users can create reports (and attachments)
    // - Admins can read/manage reports
    match /issueReports/{reportId} {
      allow create: if signedIn();
      allow read, update, delete: if isAdmin();

      match /attachments/{attachmentId} {
        allow create: if signedIn();
        allow read, update, delete: if isAdmin();
      }
    }
  }
}

